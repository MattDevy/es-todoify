name: Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no actual release)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:

  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '25'

      - name: Verify gh CLI is available
        run: |
          if ! command -v gh &> /dev/null; then
            echo "gh CLI is not available"
            exit 1
          fi
          gh --version

      - name: Run Semantic Release
        id: semantic_release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          GIT_USER_NAME: 'Elastic Machine'
          GIT_USER_EMAIL: 'elasticmachine@users.noreply.github.com'
          RELEASE_BRANCH: ${{ github.ref_name }}
          RELEASE: 'false'
        run: |
          npx --yes \
            --package semantic-release@25 \
            --package @semantic-release/changelog@6 \
            --package @semantic-release/exec@7 \
            semantic-release --dry-run --debug > dry_run_output.json 2>&1
          cat dry_run_output.json

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    if: |
      ${{ github.event_name == 'push' && 
          startsWith(github.event.head_commit.message, 'chore(release): release') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '25'

      - name: Verify gh CLI is available
        run: |
          if ! command -v gh &> /dev/null; then
            echo "gh CLI is not available"
            exit 1
          fi
          gh --version

      - name: Run Semantic Release
        id: semantic_release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          GIT_USER_NAME: 'Elastic Machine'
          GIT_USER_EMAIL: 'elasticmachine@users.noreply.github.com'
          RELEASE_BRANCH: ${{ github.ref_name }}
          RELEASE: 'true'
        run: |
          npx --yes \
            --package semantic-release@25 \
            --package @semantic-release/changelog@6 \
            --package @semantic-release/exec@7 \
            semantic-release ${{ inputs.dry-run && '--dry-run' || '' }}

      - name: Create Release Pull Request
        if: steps.semantic_release.outputs.RELEASE_VERSION != ''
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          commit-message: 'chore(release): release ${{ steps.semantic_release.outputs.RELEASE_VERSION }}'
          branch: release/${{ steps.semantic_release.outputs.RELEASE_VERSION }}
          delete-branch: true
          title: 'chore(release): release ${{ steps.semantic_release.outputs.RELEASE_VERSION }}'
          body: |
            # Release ${{ steps.semantic_release.outputs.RELEASE_VERSION }}
            
            This PR contains the changelog updates for the next release.
            Merge this PR to proceed with the release.
            
            ---
            *Auto-generated by GitHub Actions*
          base: ${{ github.ref_name }}
          labels: release
          committer: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
          author: 'Elastic Machine <elasticmachine@users.noreply.github.com>'

      - name: Create Version Bump Pull Request
        if: steps.semantic_release.outputs.HAS_CHANGES == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          commit-message: 'chore: bump version to ${{ steps.semantic_release.outputs.NEXT_VERSION }}'
          branch: chore/bump-version-${{ steps.semantic_release.outputs.NEXT_VERSION }}
          delete-branch: true
          title: 'chore: bump version to ${{ steps.semantic_release.outputs.NEXT_VERSION }}'
          body: |
            Bumps version to ${{ steps.semantic_release.outputs.NEXT_VERSION }} after release.
            
            Auto-generated by GitHub Actions.
          base: ${{ github.ref_name }}
          committer: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
          author: 'Elastic Machine <elasticmachine@users.noreply.github.com>'

