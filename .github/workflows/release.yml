name: Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no actual release)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify gh CLI is available
        run: |
          if ! command -v gh &> /dev/null; then
            echo "gh CLI is not available"
            exit 1
          fi
          gh --version

      - name: Run Semantic Release
        id: semantic_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_USER_NAME: 'Elastic Machine'
          GIT_USER_EMAIL: 'elasticmachine@users.noreply.github.com'
          RELEASE_BRANCH: ${{ github.ref_name }}
        run: |
          npx --yes \
            --package semantic-release@23 \
            --package @semantic-release/changelog@6 \
            --package @semantic-release/exec@6 \
            semantic-release ${{ inputs.dry-run && '--dry-run' || '' }}

      - name: Create Version Bump Pull Request
        if: steps.semantic_release.outputs.HAS_CHANGES == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: bump version to ${{ steps.semantic_release.outputs.NEXT_VERSION }}'
          branch: chore/bump-version-${{ steps.semantic_release.outputs.NEXT_VERSION }}
          delete-branch: true
          title: 'chore: bump version to ${{ steps.semantic_release.outputs.NEXT_VERSION }}'
          body: |
            Bumps version to ${{ steps.semantic_release.outputs.NEXT_VERSION }} after release.
            
            Auto-generated by GitHub Actions.
          base: ${{ github.ref_name }}
          committer: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
          author: 'Elastic Machine <elasticmachine@users.noreply.github.com>'

