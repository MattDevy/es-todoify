name: Release Please

on:
    push:
        branches:
            - main

permissions:
    contents: write
    issues: write
    pull-requests: write
    id-token: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        steps:
            # - name: Fetch ephemeral GitHub token
            #   id: fetch-ephemeral-token
            #   uses: elastic/ci-gh-actions/fetch-github-token@v1.0.0
            #   with:
            #       vault-instance: "ci-prod"

            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check if manifest changed
              id: check_manifest
              run: |
                  if git diff --name-only HEAD^ HEAD | grep -q '^\.github/\.release-please-manifest\.json$'; then
                    echo "manifest_changed=true" >> $GITHUB_OUTPUT
                    echo "Manifest file changed in this push"
                  else
                    echo "manifest_changed=false" >> $GITHUB_OUTPUT
                    echo "Manifest file did not change"
                  fi

            - name: Read version from manifest
              id: read_version
              if: ${{ steps.check_manifest.outputs.manifest_changed == 'true' }}
              run: |
                  VERSION=$(jq -r '."."' .github/.release-please-manifest.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
                  echo "minor=$(echo $VERSION | cut -d. -f2)" >> $GITHUB_OUTPUT
                  echo "patch=$(echo $VERSION | cut -d. -f3)" >> $GITHUB_OUTPUT
                  
                  # Extract added lines from CHANGELOG.md in this commit
                  if [ -f CHANGELOG.md ]; then
                    # Get all added lines (excluding the +++ header and ## version line)
                    BODY=$(git diff HEAD^ HEAD -- CHANGELOG.md | grep '^+' | grep -v '^+++' | grep -v "^+## \[${VERSION}\]" | sed 's/^+//' || echo "Release ${VERSION}")
                  else
                    BODY="Release ${VERSION}"
                  fi
                  
                  # Multi-line output handling
                  {
                    echo "body<<EOF"
                    echo "$BODY"
                    echo "EOF"
                  } >> $GITHUB_OUTPUT
                  
                  echo "Extracted version: $VERSION"

            - name: Run Release Please
              if: ${{ steps.check_manifest.outputs.manifest_changed == 'false' }}
              uses: googleapis/release-please-action@v4
              id: release
              with:
                  token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
                  config-file: .github/release-please-config.json
                  manifest-file: .github/.release-please-manifest.json
                  skip-labeling: 'true'

            - name: Determine if release should proceed
              id: should_release
              run: |
                  if [[ "${{ steps.check_manifest.outputs.manifest_changed }}" == "true" ]]; then
                    echo "proceed=true" >> $GITHUB_OUTPUT
                    echo "version=${{ steps.read_version.outputs.version }}" >> $GITHUB_OUTPUT
                    echo "major=${{ steps.read_version.outputs.major }}" >> $GITHUB_OUTPUT
                    echo "minor=${{ steps.read_version.outputs.minor }}" >> $GITHUB_OUTPUT
                    echo "patch=${{ steps.read_version.outputs.patch }}" >> $GITHUB_OUTPUT
                    {
                      echo "body<<EOF"
                      echo "${{ steps.read_version.outputs.body }}"
                      echo "EOF"
                    } >> $GITHUB_OUTPUT
                  elif [[ -n "${{ steps.release.outputs.version }}" ]]; then
                    echo "proceed=true" >> $GITHUB_OUTPUT
                    echo "version=${{ steps.release.outputs.version }}" >> $GITHUB_OUTPUT
                    echo "major=${{ steps.release.outputs.major }}" >> $GITHUB_OUTPUT
                    echo "minor=${{ steps.release.outputs.minor }}" >> $GITHUB_OUTPUT
                    echo "patch=${{ steps.release.outputs.patch }}" >> $GITHUB_OUTPUT
                    {
                      echo "body<<EOF"
                      echo "${{ steps.release.outputs.body }}"
                      echo "EOF"
                    } >> $GITHUB_OUTPUT
                  else
                    echo "proceed=false" >> $GITHUB_OUTPUT
                  fi

            - name: Release
              if: ${{ steps.should_release.outputs.proceed == 'true' }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ./.github/scripts/release.sh \
                    "${{ steps.should_release.outputs.version }}" \
                    "${{ steps.should_release.outputs.body }}"

            - name: Checkout main
              if: ${{ steps.should_release.outputs.proceed == 'true' }}
              uses: actions/checkout@v4
              with:
                  ref: refs/heads/main
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Bump Version
              if: ${{ steps.should_release.outputs.proceed == 'true' }}
              id: bump
              run: |
                  ./.github/scripts/bump-version.sh \
                    "${{ steps.should_release.outputs.major }}" \
                    "${{ steps.should_release.outputs.minor }}" \
                    "${{ steps.should_release.outputs.patch }}"

            - name: Create Pull Request for Version Bump
              if: ${{ steps.should_release.outputs.proceed == 'true' }}
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
                  commit-message: "chore: bump version to ${{ steps.bump.outputs.next_version }}"
                  branch: "chore/bump-snapshot-${{ steps.bump.outputs.next_version }}"
                  delete-branch: true
                  title: "chore: bump version to ${{ steps.bump.outputs.next_version }}"
                  body: |
                      Bumps version to ${{ steps.bump.outputs.next_version }} after release of v${{ steps.should_release.outputs.version }}.

                      Auto-generated by GitHub Actions.
                  base: main
                  committer: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
                  author: 'Elastic Machine <elasticmachine@users.noreply.github.com>'
